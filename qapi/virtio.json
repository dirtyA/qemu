# -*- Mode: Python -*-
# vim: filetype=python
#

##
# = Virtio devices
##

##
# @VirtioInfo:
#
# Basic information about a given VirtIODevice including the device
# canonical QOM path as well as the name of the device.
#
# @path: VirtIO device canonical QOM path
#
# @type: VirtIO device name
#
# Since: 6.2
#
##
{ 'struct': 'VirtioInfo',
    'data': {
        'path': 'str',
        'type': 'str'
    }
}

##
# @x-debug-query-virtio:
#
# Returns a list of all initalized VirtIO devices
#
# Returns: list of gathered @VirtioInfo devices
#
# Since: 6.2
#
# Example:
#
# -> { "execute": "x-debug-query-virtio" }
# <- { "return": [
#        {
#            "path": "/machine/peripheral-anon/device[4]/virtio-backend",
#            "type": "virtio-input"
#        },
#        {
#            "path": "/machine/peripheral/crypto0/virtio-backend",
#            "type": "virtio-crypto"
#        },
#        {
#            "path": "/machine/peripheral-anon/device[2]/virtio-backend",
#            "type": "virtio-scsi"
#        },
#        {
#            "path": "/machine/peripheral-anon/device[1]/virtio-backend",
#            "type": "virtio-net"
#        },
#        {
#            "path": "/machine/peripheral-anon/device[0]/virtio-backend",
#            "type": "virtio-serial"
#        }
#      ]
#    }
#
##

{ 'command': 'x-debug-query-virtio', 'returns': ['VirtioInfo'] }

##
# @VirtioStatusEndianness:
#
# Enumeration of endianness for VirtioDevice
#
# Since: 6.2
##

{ 'enum': 'VirtioStatusEndianness',
  'data': [ 'unknown', 'little', 'big' ]
}

##
# @VirtioType:
#
# An enumeration of Virtio device types (or names)
#
# Since: 6.2
##

{ 'enum': 'VirtioType',
  'data': [ 'virtio-net', 'virtio-blk', 'virtio-serial', 'virtio-rng',
            'virtio-balloon', 'virtio-iomem', 'virtio-rpmsg',
            'virtio-scsi', 'virtio-9p', 'virtio-mac-wlan',
            'virtio-rproc-serial', 'virtio-caif', 'virtio-mem-balloon',
            'virtio-gpu', 'virtio-clk', 'virtio-input', 'vhost-vsock',
            'virtio-crypto', 'virtio-signal', 'virtio-pstore',
            'virtio-iommu', 'virtio-mem', 'virtio-sound', 'vhost-user-fs',
            'virtio-pmem', 'virtio-mac-hwsim', 'vhost-user-i2c',
            'virtio-bluetooth' ]
}

##
# @VirtioConfigStatus:
#
# An enumeration of Virtio device configuration statuses
#
# Since: 6.2
##

{ 'enum': 'VirtioConfigStatus',
  'data': [ 'driver-ok', 'features-ok', 'driver', 'needs-reset',
            'failed', 'acknowledge' ]
}

##
# @VirtioDeviceStatus:
#
# A structure defined to list the configuration statuses of a virtio
# device
#
# @dev-status: List of decoded configuration statuses of the virtio
#              device
#
# @unknown-statuses: virtio device statuses bitmap that have not been decoded
#
# Since: 6.2
##

{ 'struct': 'VirtioDeviceStatus',
  'data': {
    'dev-status': [ 'VirtioConfigStatus' ],
    '*unknown-statuses': 'uint8'
  }
}

##
# @VhostProtocolFeature:
#
# An enumeration of Vhost User protocol features
#
# Since: 6.2
##

{ 'enum': 'VhostProtocolFeature',
  'data': [ 'mq', 'log-shmfd', 'rarp', 'reply-ack', 'net-mtu',
            'slave-req', 'cross-endian', 'crypto-session', 'pagefault',
            'config', 'slave-send-fd', 'host-notifier',
            'inflight-shmfd', 'reset-device', 'inband-notifications',
            'configure-mem-slots' ]
}

##
# @VhostDeviceProtocols:
#
# A structure defined to list the vhost user protocol features of a
# Vhost User device
#
# @features: List of decoded vhost user protocol features of a vhost
#            user device
#
# @unknown-protocols: vhost user device protocol features bitmap that
#                     have not been decoded
#
# Since: 6.2
##

{ 'struct': 'VhostDeviceProtocols',
    'data': {
      'features': [ 'VhostProtocolFeature' ],
      '*unknown-protocols': 'uint64'
    }
}

##
# @VirtioTransportFeature:
#
# An enumeration of Virtio device transport features, including virtio-ring
#
# Since: 6.2
##

{ 'enum': 'VirtioTransportFeature',
  'data': [ 'notify-on-empty', 'any-layout', 'protocol-features',
            'version-1', 'iommu-platform', 'ring-packed', 'order-platform',
            'sr-iov', 'indirect-desc', 'event-idx' ]
}

##
# @VirtioSerialFeature:
#
# An enumeration of Virtio serial/console features
#
# Since: 6.2
##

{ 'enum': 'VirtioSerialFeature',
  'data': [ 'size', 'multiport', 'emerg-write' ]
}

##
# @VirtioBlkFeature:
#
# An enumeration of Virtio block features
#
# Since: 6.2
##

{ 'enum': 'VirtioBlkFeature',
  'data': [ 'size-max', 'seg-max', 'geometry', 'ro', 'blk-size',
            'topology', 'mq', 'discard', 'write-zeroes', 'barrier',
            'scsi', 'flush', 'config-wce', 'log-all' ]
}

##
# @VirtioGpuFeature:
#
# An enumeration of Virtio gpu features
#
# Since: 6.2
##

{ 'enum': 'VirtioGpuFeature',
  'data': [ 'virgl', 'edid', 'resource-uuid', 'resource-blob',
            'log-all' ]
}

##
# @VirtioNetFeature:
#
# An enumeration of Virtio net features
#
# Since: 6.2
##

{ 'enum': 'VirtioNetFeature',
  'data': [ 'csum', 'guest-csum', 'ctrl-guest-offloads', 'mtu', 'mac',
            'guest-tso4', 'guest-tso6', 'guest-ecn', 'guest-ufo',
            'host-tso4', 'host-tso6', 'host-ecn', 'host-ufo',
            'mrg-rxbuf', 'status', 'ctrl-vq', 'ctrl-rx', 'ctrl-vlan',
            'ctrl-rx-extra', 'guest-announce', 'mq', 'ctrl-mac-addr',
            'hash-report', 'rss', 'rsc-ext', 'standby', 'speed-duplex',
            'gso', 'virtio-net-hdr', 'log-all' ]
}

##
# @VirtioScsiFeature:
#
# An enumeration of Virtio scsi features
#
# Since: 6.2
##

{ 'enum': 'VirtioScsiFeature',
  'data': [ 'inout', 'hotplug', 'change', 't10-pi', 'log-all' ]
}

##
# @VirtioBalloonFeature:
#
# An enumeration of Virtio balloon features
#
# Since: 6.2
##

{ 'enum': 'VirtioBalloonFeature',
  'data': [ 'must-tell-host', 'stats-vq', 'deflate-on-oom',
            'free-page-hint', 'page-poison', 'reporting' ]
}

##
# @VirtioIommuFeature:
#
# An enumeration of Virtio iommu features
#
# Since: 6.2
##

{ 'enum': 'VirtioIommuFeature',
  'data': [ 'input-range', 'domain-range', 'map-unmap', 'bypass',
            'probe', 'mmio' ]
}

##
# @VirtioInputFeature:
#
# An enumeration of Virtio input features. Note that virtio-input
# has no device-specific features except when its vhost is active,
# then it may have the VHOST_F_LOG_ALL feature.
#
# Since: 6.2
##

{ 'enum': 'VirtioInputFeature',
  'data': [ 'log-all' ]
}

##
# @VhostUserFsFeature:
#
# An enumeration of vhost user FS features. Note that vhost-user-fs
# has no device-specific features other than the vhost-common
# VHOST_F_LOG_ALL feature.
#
# Since: 6.2
##

{ 'enum': 'VhostUserFsFeature',
  'data': [ 'log-all' ]
}

##
# @VhostVsockFeature:
#
# An enumeration of vhost vsock features. Note that vhost-vsock has
# no device-specific features other than the vhost-common
# VHOST_F_LOG_ALL feature.
#
# Since: 6.2
##

{ 'enum': 'VhostVsockFeature',
  'data': [ 'log-all' ]
}

##
# @VirtioCryptoFeature:
#
# An enumeration of virtio crypto features. Not that virtio-crypto
# has no device-specific features other than when it is a vhost
# device, then it may have the VHOST_F_LOG_ALL feature.
#
# Since: 6.2
##

{ 'enum': 'VirtioCryptoFeature',
  'data': [ 'log-all' ]
}

##
# @VirtioDeviceFeaturesBase:
#
# The common fields that apply to all Virtio devices
#
# @type: virtio device name
# @transport: the list of transport features of the virtio device
# @unknown-features: virtio device features bitmap that have not been decoded
#
# Since: 6.2
##

{ 'struct': 'VirtioDeviceFeaturesBase',
    'data': {
      'type': 'VirtioType',
      'transport': [ 'VirtioTransportFeature' ],
      '*unknown-features': 'uint64'
    }
}

##
# @VirtioDeviceFeaturesOptionsSerial:
#
# The options that apply to Virtio serial devices
#
# @features: List of device features
#
# Since: 6.2
##

{ 'struct': 'VirtioDeviceFeaturesOptionsSerial',
  'data': { 'features': [ 'VirtioSerialFeature' ] }
}

##
# @VirtioDeviceFeaturesOptionsBlk:
#
# The options that apply to Virtio block devices
#
# @features: List of device features
#
# Since: 6.2
##

{ 'struct': 'VirtioDeviceFeaturesOptionsBlk',
  'data': { 'features': [ 'VirtioBlkFeature' ] }
}

##
# @VirtioDeviceFeaturesOptionsGpu:
#
# The options that apply to Virtio GPU devices
#
# @features: List of device features
#
# Since: 6.2
##

{ 'struct': 'VirtioDeviceFeaturesOptionsGpu',
  'data': { 'features': [ 'VirtioGpuFeature' ] }
}

##
# @VirtioDeviceFeaturesOptionsNet:
#
# The options that apply to Virtio net devices
#
# @features: List of device features
#
# Since: 6.2
##

{ 'struct': 'VirtioDeviceFeaturesOptionsNet',
  'data': { 'features': [ 'VirtioNetFeature' ] }
}

##
# @VirtioDeviceFeaturesOptionsScsi:
#
# The options that apply to Virtio SCSI devices
#
# @features: List of device features
#
# Since: 6.2
##

{ 'struct': 'VirtioDeviceFeaturesOptionsScsi',
  'data': { 'features': [ 'VirtioScsiFeature' ] }
}

##
# @VirtioDeviceFeaturesOptionsBalloon:
#
# The options that apply to Virtio balloon devices
#
# @features: List of device features
#
# Since: 6.2
##

{ 'struct': 'VirtioDeviceFeaturesOptionsBalloon',
  'data': { 'features': [ 'VirtioBalloonFeature' ] }
}

##
# @VirtioDeviceFeaturesOptionsIommu:
#
# The options that apply to Virtio IOMMU devices
#
# @features: List of device features
#
# Since: 6.2
##

{ 'struct': 'VirtioDeviceFeaturesOptionsIommu',
  'data': { 'features': [ 'VirtioIommuFeature' ] }
}

##
# @VirtioDeviceFeaturesOptionsInput:
#
# The options that apply to Virtio input devices
#
# @features: List of device features
#
# Since: 6.2
##

{ 'struct': 'VirtioDeviceFeaturesOptionsInput',
  'data': { 'features': [ 'VirtioInputFeature' ] }
}

##
# @VhostDeviceFeaturesOptionsFs:
#
# The options that apply to vhost-user-fs devices
#
# @features: List of device features
#
# Since: 6.2
##

{ 'struct': 'VhostDeviceFeaturesOptionsFs',
  'data': { 'features': [ 'VhostUserFsFeature' ] }
}

##
# @VhostDeviceFeaturesOptionsVsock:
#
# The options that apply to vhost-vsock devices
#
# @features: List of device features
#
# Since: 6.2
##

{ 'struct': 'VhostDeviceFeaturesOptionsVsock',
  'data': { 'features': [ 'VhostVsockFeature' ] }
}

##
# @VirtioDeviceFeaturesOptionsCrypto:
#
# The options that apply to virtio-crypto devices
#
# @features: List of device features
#
# Since: 6.2
##

{ 'struct': 'VirtioDeviceFeaturesOptionsCrypto',
  'data': { 'features': [ 'VirtioCryptoFeature' ] }
}

##
# @VirtioDeviceFeatures:
#
# A union to define the list of features for a virtio device
#
# Since: 6.2
##

{ 'union': 'VirtioDeviceFeatures',
  'base': 'VirtioDeviceFeaturesBase',
  'discriminator': 'type',
  'data': {
    'virtio-serial': 'VirtioDeviceFeaturesOptionsSerial',
    'virtio-blk': 'VirtioDeviceFeaturesOptionsBlk',
    'virtio-gpu': 'VirtioDeviceFeaturesOptionsGpu',
    'virtio-net': 'VirtioDeviceFeaturesOptionsNet',
    'virtio-scsi': 'VirtioDeviceFeaturesOptionsScsi',
    'virtio-balloon': 'VirtioDeviceFeaturesOptionsBalloon',
    'virtio-iommu': 'VirtioDeviceFeaturesOptionsIommu',
    'virtio-input': 'VirtioDeviceFeaturesOptionsInput',
    'vhost-user-fs': 'VhostDeviceFeaturesOptionsFs',
    'vhost-vsock': 'VhostDeviceFeaturesOptionsVsock',
    'virtio-crypto': 'VirtioDeviceFeaturesOptionsCrypto'
  }
}

##
# @VhostStatus:
#
# Information about a vhost device. This information will only be
# displayed if the vhost device is active.
#
# @n-mem-sections: vhost_dev n_mem_sections
#
# @n-tmp-sections: vhost_dev n_tmp_sections
#
# @nvqs: vhost_dev nvqs. This is the number of virtqueues being used
#        by the vhost device.
#
# @vq-index: vhost_dev vq_index
#
# @features: vhost_dev features
#
# @acked-features: vhost_dev acked_features
#
# @backend-features: vhost_dev backend_features
#
# @protocol-features: vhost_dev protocol_features
#
# @max-queues: vhost_dev max_queues
#
# @backend-cap: vhost_dev backend_cap
#
# @log-enabled: vhost_dev log_enabled flag
#
# @log-size: vhost_dev log_size
#
# Since: 6.2
#
##

{ 'struct': 'VhostStatus',
    'data': {
        'n-mem-sections': 'int',
        'n-tmp-sections': 'int',
        'nvqs': 'uint32',
        'vq-index': 'int',
        'features': 'VirtioDeviceFeatures',
        'acked-features': 'VirtioDeviceFeatures',
        'backend-features': 'VirtioDeviceFeatures',
        'protocol-features': 'VhostDeviceProtocols',
        'max-queues': 'uint64',
        'backend-cap': 'uint64',
        'log-enabled': 'bool',
        'log-size': 'uint64'
    }
}

##
# @VirtioStatus:
#
# Full status of the virtio device with most VirtIODevice members.
# Also includes the full status of the corresponding vhost device
# if the vhost device is active.
#
# @name: VirtIODevice name
#
# @device-id: VirtIODevice ID
#
# @vhost-started: VirtIODevice vhost_started flag
#
# @guest-features: VirtIODevice guest_features
#
# @host-features: VirtIODevice host_features
#
# @backend-features: VirtIODevice backend_features
#
# @device-endian: VirtIODevice device_endian
#
# @num-vqs: VirtIODevice virtqueue count. This is the number of active
#           virtqueues being used by the VirtIODevice.
#
# @status: VirtIODevice configuration status (e.g. DRIVER_OK,
#          FEATURES_OK, DRIVER, etc.)
#
# @isr: VirtIODevice ISR
#
# @queue-sel: VirtIODevice queue_sel
#
# @vm-running: VirtIODevice vm_running flag
#
# @broken: VirtIODevice broken flag
#
# @disabled: VirtIODevice disabled flag
#
# @use-started: VirtIODevice use_started flag
#
# @started: VirtIODevice started flag
#
# @start-on-kick: VirtIODevice start_on_kick flag
#
# @disable-legacy-check: VirtIODevice disabled_legacy_check flag
#
# @bus-name: VirtIODevice bus_name
#
# @use-guest-notifier-mask: VirtIODevice use_guest_notifier_mask flag
#
# @vhost-dev: corresponding vhost device info for a given VirtIODevice
#
# Since: 6.2
#
##

{ 'struct': 'VirtioStatus',
    'data': {
        'name': 'str',
        'device-id': 'uint16',
        'vhost-started': 'bool',
        'guest-features': 'VirtioDeviceFeatures',
        'host-features': 'VirtioDeviceFeatures',
        'backend-features': 'VirtioDeviceFeatures',
        'device-endian': 'VirtioStatusEndianness',
        'num-vqs': 'int',
        'status': 'VirtioDeviceStatus',
        'isr': 'uint8',
        'queue-sel': 'uint16',
        'vm-running': 'bool',
        'broken': 'bool',
        'disabled': 'bool',
        'use-started': 'bool',
        'started': 'bool',
        'start-on-kick': 'bool',
        'disable-legacy-check': 'bool',
        'bus-name': 'str',
        'use-guest-notifier-mask': 'bool',
        '*vhost-dev': 'VhostStatus'
    }
}

##
# @x-debug-virtio-status:
#
# Poll for a comprehensive status of a given virtio device
#
# @path: Canonical QOM path of the VirtIODevice
#
# Returns: VirtioStatus of the virtio device
#
# Since: 6.2
#
# Examples:
#
# 1. Poll for the status of virtio-crypto (no vhost-crypto active)
#
# -> { "execute": "x-debug-virtio-status",
#      "arguments": {
#          "path": "/machine/peripheral/crypto0/virtio-backend"
#      }
#    }
# <- { "return": {
#          "device-endian": "little",
#          "bus-name": "",
#          "disable-legacy-check": false,
#          "name": "virtio-crypto",
#          "started": true,
#          "device-id": 20,
#          "backend-features": {
#               "transport": [],
#               "type": "virtio-crypto",
#               "features": []
#          },
#          "start-on-kick": false,
#          "isr": 1,
#          "broken": false,
#          "status": {
#               "dev-status": ["acknowledge", "driver", "features-ok",
#                              "driver-ok"]
#          },
#          "num-vqs": 2,
#          "guest-features": {
#               "transport": ["event-idx", "indirect-desc", "version-1"],
#               "type": "virtio-crypto",
#               "features": []
#          },
#          "host-features": {
#               "transport": ["protocol-features", "event-idx",
#                             "indirect-desc", "version-1", "any-layout",
#                             "notify-on-empty"],
#               "type": "virtio-crypto",
#               "features": []
#          },
#          "use-guest-notifier-mask": true,
#          "vm-running": true,
#          "queue-sel": 1,
#          "disabled": false,
#          "vhost-started": false,
#          "use-started": true
#      }
#    }
#
# 2. Poll for the status of virtio-net (vhost-net is active)
#
# -> { "execute": "x-debug-virtio-status",
#      "arguments": {
#          "path": "/machine/peripheral-anon/device[1]/virtio-backend"
#      }
#    }
# <- { "return": {
#          "device-endian": "little",
#          "bus-name": "",
#          "disabled-legacy-check": false,
#          "name": "virtio-net",
#          "started": true,
#          "device-id": 1,
#          "vhost-dev": {
#               "n-tmp-sections": 4,
#               "n-mem-sections": 4,
#               "max-queues": 1,
#               "backend-cap": 2,
#               "log-size": 0,
#               "backend-features": {
#                       "transport": [],
#                       "type": "virtio-net",
#                       "features": []
#               },
#               "nvqs": 2,
#               "protocol-features": {
#                       "features": []
#               },
#               "vq-index": 0,
#               "log-enabled": false,
#               "acked-features": {
#                       "transport": ["event-idx", "indirect-desc", "version-1",
#                                     "any-layout", "notify-on-empty"],
#                       "type": "virtio-net",
#                       "features": ["mrg-rxbuf"]
#               },
#               "features": {
#                       "transport": ["event-idx", "indirect-desc",
#                                     "iommu-platform", "version-1", "any-layout",
#                                     "notify-on-empty"],
#                       "type": "virtio-net",
#                       "features": ["log-all", "mrg-rxbuf"]
#               }
#          },
#          "backend-features": {
#               "transport": ["protocol-features", "event-idx", "indirect-desc",
#                             "version-1", "any-layout", "notify-on-empty"],
#               "type": "virtio-net",
#               "features": ["gso", "ctrl-mac-addr", "guest-announce", "ctrl-rx-extra",
#                            "ctrl-vlan", "ctrl-rx", "ctrl-vq", "status", "mrg-rxbuf",
#                            "host-ufo", "host-ecn", "host-tso6", "host-tso4",
#                            "guest-ufo", "guest-ecn", "guest-tso6", "guest-tso4",
#                            "mac", "ctrl-guest-offloads", "guest-csum", "csum"]
#          },
#          "start-on-kick": false,
#          "isr": 1,
#          "broken": false,
#          "status": {
#               "dev-status": ["acknowledge", "driver", "features-ok", "driver-ok"]
#          },
#          "num-vqs": 3,
#          "guest-features": {
#               "transport": ["event-idx", "indirect-desc", "version-1"],
#               "type": "virtio-net",
#               "features": ["ctrl-mac-addr", "guest-announce", "ctrl-vlan",
#                            "ctrl-rx", "ctrl-vq", "status", "mrg-rxbuf",
#                            "host-ufo", "host-ecn", "host-tso6",
#                            "host-tso4", "guest-ufo", "guest-ecn",
#                            "guest-tso6", "guest-tso4", "mac",
#                            "ctrl-guest-offloads", "guest-csum", "csum"]
#          },
#          "host-features": {
#               "transport": ["protocol-features", "event-idx",
#                             "indirect-desc", "version-1", "any-layout",
#                             "notify-on-empty"],
#               "type": "virtio-net",
#               "features": ["gso", "ctrl-mac-addr", "guest-announce",
#                            "ctrl-rx-extra", "ctrl-vlan", "ctrl-rx",
#                            "ctrl-vq", "status", "mrg-rxbuf", "host-ufo",
#                            "host-ecn", "host-tso6", "host-tso4",
#                            "guest-ufo", "guest-ecn", "guest-tso6",
#                            "guest-tso4", "mac", "ctrl-guest-offloads",
#                            "guest-csum", "csum"]
#          },
#          "use-guest-notifier-mask": true,
#          "vm-running": true,
#          "queue-sel": 2,
#          "disabled": false,
#          "vhost-started": true,
#          "use-started": true
#      }
#    }
#
##

{ 'command': 'x-debug-virtio-status',
  'data': { 'path': 'str' },
  'returns': 'VirtioStatus'
}
